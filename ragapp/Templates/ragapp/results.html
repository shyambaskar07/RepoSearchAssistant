{% extends "ragapp/base.html" %}
{% block content %}
  <form class="row g-2" method="get" action="{% url 'search_files' %}">
    <div class="col-auto">
      <input class="form-control" type="text" name="q" value="{{ query }}" placeholder="Search..." required>
    </div>
    <div class="col-auto">
      <button class="btn btn-primary">Search</button>
    </div>
  </form>

  {% if results %}
    <!-- Button trigger modal (hidden) -->
    <button type="button" id="openModalBtn" class="btn btn-primary d-none" data-bs-toggle="modal" data-bs-target="#resultsModal"></button>

    <!-- Modal -->
    <div class="modal fade" id="resultsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Related files for: "{{ query }}"</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <ul class="list-group">
              {% for r in results %}
                <li class="list-group-item">
                  <strong>{{ r.file.name }}</strong>
                  <div>Score: {{ r.score|floatformat:2 }}</div>
                  <details>
                    <summary>Preview</summary>
                    <pre style="white-space: pre-wrap;">{{ r.file.text|truncatechars:1000 }}</pre>
                  </details>
                  <a href="{{ r.file.file.url }}" target="_blank" class="btn btn-sm btn-outline-primary mt-2">Open file</a>
                </li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function(){
        // click hidden button to show modal if results exist
        document.getElementById("openModalBtn").click();
      });
    </script>
  {% else %}
    {% if query %}
      <div class="alert alert-warning mt-3">No related files found.</div>
    {% endif %}
  {% endif %}
{% endblock %}
